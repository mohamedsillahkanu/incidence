<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Indicator Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #e1effe;
            background: linear-gradient(135deg, #0a0e1a 0%, #0f1629 25%, #1a237e 75%, #1565c0 100%);
            min-height: 100vh;
        }

        .main-header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 25%, #1e3a8a 75%, #2563eb 100%);
            color: white;
            margin-bottom: 2rem;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .main-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .main-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin: 2rem 0;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .section h3 {
            color: #93c5fd;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .section p {
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 1rem 1rem 1rem 0;
        }

        .file-input {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
        }

        .file-input:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(29, 78, 216, 0.6);
        }

        .file-input input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            backdrop-filter: blur(15px);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2) 0%, rgba(4, 120, 87, 0.2) 100%);
            border-left: 4px solid #059669;
            color: #6ee7b7;
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2) 0%, rgba(185, 28, 28, 0.2) 100%);
            border-left: 4px solid #dc2626;
            color: #fca5a5;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(2, 132, 199, 0.2) 100%);
            border-left: 4px solid #0ea5e9;
            color: #7dd3fc;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.8);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(37, 99, 235, 0.2);
        }

        .table th {
            background: rgba(30, 58, 138, 0.5);
            color: #93c5fd;
            font-weight: 600;
        }

        .table td {
            color: #e1effe;
        }

        .table tbody tr:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .column-selection {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .column-selection h4 {
            color: #93c5fd;
            margin-bottom: 1rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
            border: 1px solid rgba(37, 99, 235, 0.2);
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #2563eb;
        }

        .checkbox-item label {
            color: #e1effe;
            cursor: pointer;
            margin-bottom: 0;
            font-weight: normal;
        }

        .select-all-buttons {
            margin: 1rem 0;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .close {
            color: #9ca3af;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e1effe;
        }

        .footer {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid rgba(37, 99, 235, 0.2);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 0 10px;
            }

            .section {
                padding: 1rem;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>REPORT INDICATOR PROCESSOR</h1>
        <p>Upload your data and create a reporting indicator based on selected columns</p>
    </div>

    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- File Upload Section -->
        <div class="section">
            <h3>Upload Your Data File</h3>
            <p>Upload your data file in CSV or Excel format. After upload, you'll be able to select columns to consider for the reporting indicator.</p>
            
            <div class="file-input-wrapper">
                <label class="file-input">
                    Upload Data File (.xlsx, .xls, .csv)
                    <input type="file" id="dataFileInput" accept=".xlsx,.xls,.csv">
                </label>
            </div>

            <div id="previewContainer" class="hidden">
                <div id="dataPreview"></div>
                <button id="selectColumnsBtn" class="btn btn-primary">Select Columns for Report</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="section hidden">
            <h3>Results</h3>
            <div id="resultsContainer"></div>
            <div style="text-align: center; margin-top: 2rem;">
                <button id="downloadBtn" class="btn btn-success">Download File with Report Column</button>
                <button id="startOverBtn" class="btn btn-secondary">Start Over</button>
            </div>
        </div>
    </div>

    <!-- Column Selection Modal -->
    <div id="columnModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 style="color: #93c5fd; margin-bottom: 1rem;">Select Columns for Report Indicator</h3>
            <p style="color: #9ca3af; margin-bottom: 1rem;">
                Select which columns to consider for the report indicator. If ANY of the selected columns contains a value that is not NA/null/empty, the report will be set to 1, otherwise 0.
            </p>
            
            <div class="column-selection">
                <h4>Available Columns</h4>
                <div class="select-all-buttons">
                    <button id="selectAllBtn" class="btn btn-primary btn-small">Select All</button>
                    <button id="deselectAllBtn" class="btn btn-secondary btn-small">Deselect All</button>
                </div>
                <div id="columnCheckboxes" class="checkbox-group">
                    <!-- Checkboxes will be populated dynamically -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button id="generateReportBtn" class="btn btn-success">Generate Report Column</button>
                <button id="cancelBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Report Indicator Processor | Simple and Efficient Data Processing</p>
    </div>

    <script>
        // Global variables
        let uploadedData = null;
        let processedData = null;
        let selectedColumns = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            bindEventListeners();
        });

        function bindEventListeners() {
            document.getElementById('dataFileInput').addEventListener('change', handleFileUpload);
            document.getElementById('selectColumnsBtn').addEventListener('click', showColumnModal);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            document.getElementById('cancelBtn').addEventListener('click', hideColumnModal);
            document.getElementById('downloadBtn').addEventListener('click', downloadFile);
            document.getElementById('startOverBtn').addEventListener('click', startOver);
            document.getElementById('selectAllBtn').addEventListener('click', selectAllColumns);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllColumns);

            // Modal close functionality
            const modal = document.getElementById('columnModal');
            const closeBtn = document.querySelector('.close');
            
            closeBtn.addEventListener('click', hideColumnModal);
            
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideColumnModal();
                }
            });
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;

            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                showAlert('Please upload an Excel file (.xlsx, .xls) or CSV file (.csv)', 'error');
                return;
            }

            if (fileExtension === 'csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false, // Keep as strings to better handle NA values
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            showAlert('Error reading CSV file: ' + results.errors[0].message, 'error');
                            return;
                        }
                        
                        uploadedData = results.data;
                        showPreview(uploadedData, fileName);
                        showAlert(`CSV file (${fileName}) uploaded successfully!`, 'success');
                        document.getElementById('previewContainer').classList.remove('hidden');
                    },
                    error: function(error) {
                        showAlert('Error reading CSV file: ' + error.message, 'error');
                    }
                });
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {raw: false}); // Keep as strings
                        
                        uploadedData = jsonData;
                        showPreview(jsonData, fileName);
                        showAlert(`Excel file (${fileName}) uploaded successfully!`, 'success');
                        document.getElementById('previewContainer').classList.remove('hidden');
                    } catch (error) {
                        showAlert('Error reading Excel file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function showPreview(data, fileName) {
            const container = document.getElementById('dataPreview');
            
            let html = `<h4 style="color: #93c5fd; margin: 1rem 0;">Data Preview (${fileName})</h4>`;
            html += `<div class="alert alert-info">Found ${data.length} records with ${Object.keys(data[0] || {}).length} columns</div>`;
            
            if (data.length > 0) {
                html += '<div class="table-container"><table class="table">';
                const columns = Object.keys(data[0]);
                
                html += '<thead><tr>';
                columns.slice(0, 8).forEach(col => {
                    html += `<th>${col}</th>`;
                });
                if (columns.length > 8) html += '<th>...</th>';
                html += '</tr></thead>';
                
                html += '<tbody>';
                data.slice(0, 5).forEach(row => {
                    html += '<tr>';
                    columns.slice(0, 8).forEach(col => {
                        const value = row[col];
                        const displayValue = (value === null || value === undefined || value === '') ? 'NA' : value;
                        html += `<td>${displayValue}</td>`;
                    });
                    if (columns.length > 8) html += '<td>...</td>';
                    html += '</tr>';
                });
                html += '</tbody>';
                
                html += '</table></div>';
                html += `<p style="color: #9ca3af; margin-top: 1rem;">Showing first 5 rows and 8 columns of ${data.length} total records</p>`;
            }
            
            container.innerHTML = html;
        }

        function showColumnModal() {
            if (!uploadedData || uploadedData.length === 0) {
                showAlert('No data available. Please upload a file first.', 'error');
                return;
            }

            const columns = Object.keys(uploadedData[0]);
            const container = document.getElementById('columnCheckboxes');
            container.innerHTML = '';

            columns.forEach(col => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col_${col}`;
                checkbox.value = col;
                checkbox.name = 'columnSelection';
                
                const label = document.createElement('label');
                label.htmlFor = `col_${col}`;
                label.textContent = col;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                container.appendChild(checkboxItem);
            });

            document.getElementById('columnModal').style.display = 'block';
        }

        function hideColumnModal() {
            document.getElementById('columnModal').style.display = 'none';
        }

        function selectAllColumns() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllColumns() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function generateReport() {
            console.log('Generate report button clicked');
            
            // FIXED: Get selected columns from the correct container
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked');
            selectedColumns = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            console.log('Selected columns:', selectedColumns);

            if (selectedColumns.length === 0) {
                showAlert('Please select at least one column for the report indicator.', 'error');
                return;
            }

            if (!uploadedData || uploadedData.length === 0) {
                showAlert('No data available for processing.', 'error');
                return;
            }

            // Check if 'report' column already exists
            const hasReportColumn = uploadedData[0].hasOwnProperty('report');
            if (hasReportColumn) {
                if (!confirm('A "report" column already exists. Do you want to overwrite it?')) {
                    return;
                }
            }

            try {
                // Create report indicator
                processedData = uploadedData.map(row => {
                    const newRow = {...row};
                    
                    // Check if any selected column has a non-NA value
                    let hasValue = false;
                    for (const col of selectedColumns) {
                        const value = row[col];
                        if (value !== null && value !== undefined && value !== '' && 
                            value !== 'NA' && value !== 'na' && value !== 'N/A' && 
                            String(value).trim() !== '') {
                            hasValue = true;
                            break;
                        }
                    }
                    
                    newRow.report = hasValue ? 1 : 0;
                    return newRow;
                });

                console.log('Report generated successfully');
                hideColumnModal();
                showResults();
                showAlert(`Report column generated successfully using ${selectedColumns.length} columns!`, 'success');
            } catch (error) {
                console.error('Error generating report:', error);
                showAlert('Error generating report: ' + error.message, 'error');
            }
        }

        function showResults() {
            const container = document.getElementById('resultsContainer');
            
            // Calculate summary statistics
            const totalRecords = processedData.length;
            const reportedRecords = processedData.filter(row => row.report === 1).length;
            const notReportedRecords = totalRecords - reportedRecords;
            const reportingRate = totalRecords > 0 ? Math.round((reportedRecords / totalRecords) * 100 * 100) / 100 : 0;

            let html = `
                <div class="alert alert-success">
                    Report column generated successfully based on columns: <strong>${selectedColumns.join(', ')}</strong>
                </div>
                
                <div class="column-selection">
                    <h4>Summary Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #93c5fd; font-size: 1.5rem; font-weight: bold;">${totalRecords}</div>
                            <div style="color: #9ca3af;">Total Records</div>
                        </div>
                        <div style="background: rgba(5, 150, 105, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #6ee7b7; font-size: 1.5rem; font-weight: bold;">${reportedRecords}</div>
                            <div style="color: #9ca3af;">Reported (1)</div>
                        </div>
                        <div style="background: rgba(220, 38, 38, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #fca5a5; font-size: 1.5rem; font-weight: bold;">${notReportedRecords}</div>
                            <div style="color: #9ca3af;">Not Reported (0)</div>
                        </div>
                        <div style="background: rgba(14, 165, 233, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #7dd3fc; font-size: 1.5rem; font-weight: bold;">${reportingRate}%</div>
                            <div style="color: #9ca3af;">Reporting Rate</div>
                        </div>
                    </div>
                </div>
            `;

            // Show preview of data with report column
            html += '<h4 style="color: #93c5fd; margin: 1rem 0;">Data Preview with Report Column</h4>';
            html += '<div class="table-container"><table class="table">';
            
            if (processedData.length > 0) {
                const columns = Object.keys(processedData[0]);
                const reportIndex = columns.indexOf('report');
                
                // Move report column to the front for better visibility
                if (reportIndex > -1) {
                    columns.splice(reportIndex, 1);
                    columns.unshift('report');
                }
                
                html += '<thead><tr>';
                columns.slice(0, 8).forEach(col => {
                    if (col === 'report') {
                        html += `<th style="background: rgba(5, 150, 105, 0.5);">${col}</th>`;
                    } else {
                        html += `<th>${col}</th>`;
                    }
                });
                if (columns.length > 8) html += '<th>...</th>';
                html += '</tr></thead>';
                
                html += '<tbody>';
                processedData.slice(0, 10).forEach(row => {
                    html += '<tr>';
                    columns.slice(0, 8).forEach(col => {
                        const value = row[col];
                        let displayValue = (value === null || value === undefined || value === '') ? 'NA' : value;
                        
                        if (col === 'report') {
                            const bgColor = value === 1 ? 'rgba(5, 150, 105, 0.3)' : 'rgba(220, 38, 38, 0.3)';
                            html += `<td style="background: ${bgColor}; font-weight: bold;">${displayValue}</td>`;
                        } else {
                            html += `<td>${displayValue}</td>`;
                        }
                    });
                    if (columns.length > 8) html += '<td>...</td>';
                    html += '</tr>';
                });
                html += '</tbody>';
            }
            
            html += '</table></div>';
            html += `<p style="color: #9ca3af; margin-top: 1rem;">Showing first 10 rows of ${processedData.length} total records</p>`;

            container.innerHTML = html;
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function downloadFile() {
            if (!processedData || processedData.length === 0) {
                showAlert('No processed data available for download.', 'error');
                return;
            }

            try {
                // Show loading state
                const downloadBtn = document.getElementById('downloadBtn');
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'Preparing download...';
                downloadBtn.disabled = true;

                // Create worksheet with the processed data (includes report column)
                const ws = XLSX.utils.json_to_sheet(processedData);
                
                // Auto-size columns for better readability
                const columns = Object.keys(processedData[0]);
                const colWidths = columns.map(col => {
                    const maxLength = Math.max(
                        col.length,
                        ...processedData.slice(0, 100).map(row => 
                            String(row[col] || '').length
                        )
                    );
                    return { wch: Math.min(Math.max(maxLength + 2, 10), 50) };
                });
                ws['!cols'] = colWidths;

                // Highlight the report column
                const reportColIndex = columns.indexOf('report');
                if (reportColIndex !== -1) {
                    const reportColLetter = XLSX.utils.encode_col(reportColIndex);
                    
                    // Style the header
                    const headerCell = ws[reportColLetter + '1'];
                    if (headerCell) {
                        headerCell.s = {
                            fill: { fgColor: { rgb: "4CAF50" } },
                            font: { bold: true, color: { rgb: "FFFFFF" } }
                        };
                    }
                }

                // Create workbook and add worksheet
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data_with_Report');
                
                // Add metadata sheet
                const metaData = [
                    ['Report Generation Summary', ''],
                    ['Generated on', new Date().toLocaleString()],
                    ['Total records', processedData.length],
                    ['Selected columns', selectedColumns.join(', ')],
                    ['Records with report=1', processedData.filter(row => row.report === 1).length],
                    ['Records with report=0', processedData.filter(row => row.report === 0).length],
                    ['Reporting rate (%)', Math.round((processedData.filter(row => row.report === 1).length / processedData.length) * 100 * 100) / 100]
                ];
                
                const metaWs = XLSX.utils.aoa_to_sheet(metaData);
                XLSX.utils.book_append_sheet(wb, metaWs, 'Report_Summary');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `data_with_report_${timestamp}.xlsx`;
                
                // Download the file
                XLSX.writeFile(wb, filename);
                
                // Show success message
                showAlert(`âœ… File downloaded successfully as "${filename}"!\nðŸ“Š Report column added to ${processedData.length} records\nðŸ“ˆ ${processedData.filter(row => row.report === 1).length} records marked as reported (1)`, 'success');
                
                // Reset button
                setTimeout(() => {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Error downloading file:', error);
                showAlert('Error downloading file: ' + error.message, 'error');
                
                // Reset button on error
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.textContent = 'Download File with Report Column';
                downloadBtn.disabled = false;
            }
        }

        function startOver() {
            uploadedData = null;
            processedData = null;
            selectedColumns = [];
            
            document.getElementById('dataFileInput').value = '';
            document.getElementById('dataPreview').innerHTML = '';
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            hideColumnModal();
            showAlert('Application reset. Please upload your data file again.', 'info');
        }
    </script>
</body>
</html>
