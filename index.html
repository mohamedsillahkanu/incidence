<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Malaria Incidence Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #e1effe;
            background: linear-gradient(135deg, #0a0e1a 0%, #0f1629 25%, #1a237e 75%, #1565c0 100%);
            min-height: 100vh;
        }

        .main-header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 25%, #1e3a8a 75%, #2563eb 100%);
            color: white;
            margin-bottom: 2rem;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .main-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .main-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(15px);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin: 2rem 0;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .section h3 {
            color: #93c5fd;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .section p {
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #93c5fd;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(30, 64, 175, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(15, 23, 42, 0.9);
            color: #e1effe;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 5px;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .checkbox-item label {
            color: #e1effe;
            cursor: pointer;
            margin: 0;
            font-weight: normal;
            font-size: 0.9rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 1rem 1rem 1rem 0;
        }

        .file-input {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
        }

        .file-input:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(29, 78, 216, 0.6);
        }

        .file-input input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            backdrop-filter: blur(15px);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2) 0%, rgba(4, 120, 87, 0.2) 100%);
            border-left: 4px solid #059669;
            color: #6ee7b7;
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2) 0%, rgba(185, 28, 28, 0.2) 100%);
            border-left: 4px solid #dc2626;
            color: #fca5a5;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(2, 132, 199, 0.2) 100%);
            border-left: 4px solid #0ea5e9;
            color: #7dd3fc;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border-left: 4px solid #fbbf24;
            color: #fde68a;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.8);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(37, 99, 235, 0.2);
        }

        .table th {
            background: rgba(30, 58, 138, 0.5);
            color: #93c5fd;
            font-weight: 600;
        }

        .table td {
            color: #e1effe;
        }

        .table tbody tr:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .column-mapping {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .column-mapping h4 {
            color: #93c5fd;
            margin-bottom: 1rem;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(30, 64, 175, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .footer {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid rgba(37, 99, 235, 0.2);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 0 10px;
            }

            .section {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>MALARIA INCIDENCE CALCULATOR</h1>
        <p>Upload your data first, then map columns and select years for analysis</p>
    </div>

    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Step 1: File Upload -->
        <div id="step1" class="section">
            <h3>Step 1: Upload Your Data File</h3>
            <p>Upload your malaria data file in Excel format. We'll analyze the columns after upload.</p>
            
            <div class="file-input-wrapper">
                <label class="file-input">
                    Upload Data File (.xlsx)
                    <input type="file" id="dataFileInput" accept=".xlsx,.xls">
                </label>
            </div>

            <div id="previewContainer" class="hidden">
                <div id="dataPreview"></div>
                <button id="proceedToMappingBtn" class="btn btn-primary">Proceed to Column Mapping</button>
            </div>
        </div>

        <!-- Step 2: Column Mapping -->
        <div id="step2" class="section hidden">
            <h3>Step 2: Map Your Columns</h3>
            <p>Select which columns in your data correspond to the required variables for malaria incidence calculations.</p>
            
            <div class="column-mapping">
                <h4>Required Column Mappings</h4>
                <div class="mapping-grid">
                    <div class="form-group">
                        <label for="yearColumn">Year Column:</label>
                        <select id="yearColumn" class="form-control">
                            <option value="">Select year column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adm1Column">Administrative Level 1 (ADM1):</label>
                        <select id="adm1Column" class="form-control">
                            <option value="">Select ADM1 column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adm2Column">Administrative Level 2 (ADM2):</label>
                        <select id="adm2Column" class="form-control">
                            <option value="">Select ADM2 column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adm3Column">Administrative Level 3 (ADM3):</label>
                        <select id="adm3Column" class="form-control">
                            <option value="">Select ADM3 column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="confColumn">Confirmed Cases Column:</label>
                        <select id="confColumn" class="form-control">
                            <option value="">Select confirmed cases...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="testColumn">Tests Performed Column:</label>
                        <select id="testColumn" class="form-control">
                            <option value="">Select tests column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="presColumn">Presumed Cases Column:</label>
                        <select id="presColumn" class="form-control">
                            <option value="">Select presumed cases...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="publicColumn">Public Sector Proportion:</label>
                        <select id="publicColumn" class="form-control">
                            <option value="">Select public proportion...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="privateColumn">Private Sector Proportion:</label>
                        <select id="privateColumn" class="form-control">
                            <option value="">Select private proportion...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="nonColumn">Non-facility Care Proportion:</label>
                        <select id="nonColumn" class="form-control">
                            <option value="">Select non-facility proportion...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button id="analyzeYearsBtn" class="btn btn-primary">Analyze Available Years</button>
            </div>
        </div>

        <!-- Step 3: Year Selection and Additional Columns -->
        <div id="step3" class="section hidden">
            <h3>Step 3: Select Years and Additional Columns</h3>
            
            <div id="availableYearsInfo" class="alert alert-info"></div>
            
            <div class="form-group">
                <label>Select Years to Include (minimum 2):</label>
                <div class="checkbox-group" id="yearSelection">
                    <!-- Years will be populated dynamically -->
                </div>
            </div>

            <div id="additionalColumnsSection" class="hidden">
                <div class="column-mapping">
                    <h4>Year-Specific Columns</h4>
                    <p>For each selected year, map the population and reporting rate columns:</p>
                    <div id="yearSpecificMappings"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button id="startCalculationBtn" class="btn btn-success" disabled>Start Calculations</button>
            </div>
        </div>

        <!-- Step 4: Processing -->
        <div id="step4" class="section hidden">
            <h3>Step 4: Processing Data</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="processingLog"></div>
        </div>

        <!-- Step 5: Results -->
        <div id="step5" class="section hidden">
            <h3>Step 5: Results</h3>
            <div id="resultsContainer"></div>
            <div style="text-align: center; margin-top: 2rem;">
                <button id="downloadResultsBtn" class="btn btn-success">Download Results</button>
                <button id="startOverBtn" class="btn btn-secondary">Start Over</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Universal Malaria Incidence Calculator | Flexible Column Mapping & Year Selection</p>
    </div>

    <script>
        // Global variables
        let uploadedData = null;
        let columnMappings = {};
        let selectedYears = [];
        let processedData = null;
        let availableYears = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            bindEventListeners();
        });

        function bindEventListeners() {
            document.getElementById('dataFileInput').addEventListener('change', handleFileUpload);
            document.getElementById('proceedToMappingBtn').addEventListener('click', () => showStep(2));
            document.getElementById('analyzeYearsBtn').addEventListener('click', analyzeYears);
            document.getElementById('startCalculationBtn').addEventListener('click', startCalculations);
            document.getElementById('downloadResultsBtn').addEventListener('click', downloadResults);
            document.getElementById('startOverBtn').addEventListener('click', startOver);
        }

        function showStep(stepNumber) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) step.classList.add('hidden');
            }
            
            const currentStepEl = document.getElementById(`step${stepNumber}`);
            if (currentStepEl) {
                currentStepEl.classList.remove('hidden');
            }
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;

            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (!['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                showAlert('Please upload an Excel file (.xlsx, .xls) or CSV file (.csv)', 'error');
                return;
            }

            if (fileExtension === 'csv') {
                // Handle CSV files
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            showAlert('Error reading CSV file: ' + results.errors[0].message, 'error');
                            return;
                        }
                        
                        uploadedData = results.data;
                        showPreview(uploadedData, fileName);
                        setupColumnMappings(uploadedData);
                        showAlert(`CSV file (${fileName}) uploaded successfully!`, 'success');
                        document.getElementById('previewContainer').classList.remove('hidden');
                    },
                    error: function(error) {
                        showAlert('Error reading CSV file: ' + error.message, 'error');
                    }
                });
            } else {
                // Handle Excel files
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        uploadedData = jsonData;
                        showPreview(jsonData, fileName);
                        setupColumnMappings(jsonData);
                        showAlert(`Excel file (${fileName}) uploaded successfully!`, 'success');
                        document.getElementById('previewContainer').classList.remove('hidden');
                    } catch (error) {
                        showAlert('Error reading Excel file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function showPreview(data, fileName) {
            const container = document.getElementById('dataPreview');
            
            let html = `<h4 style="color: #93c5fd; margin: 1rem 0;">Data Preview (${fileName})</h4>`;
            html += `<div class="alert alert-info">Found ${data.length} records with ${Object.keys(data[0]).length} columns</div>`;
            html += '<div class="table-container"><table class="table">';
            
            if (data.length > 0) {
                const columns = Object.keys(data[0]);
                
                html += '<thead><tr>';
                columns.slice(0, 8).forEach(col => {
                    html += `<th>${col}</th>`;
                });
                if (columns.length > 8) html += '<th>...</th>';
                html += '</tr></thead>';
                
                html += '<tbody>';
                data.slice(0, 5).forEach(row => {
                    html += '<tr>';
                    columns.slice(0, 8).forEach(col => {
                        html += `<td>${row[col] || ''}</td>`;
                    });
                    if (columns.length > 8) html += '<td>...</td>';
                    html += '</tr>';
                });
                html += '</tbody>';
            }
            
            html += '</table></div>';
            html += `<p style="color: #9ca3af; margin-top: 1rem;">Showing first 5 rows and 8 columns of ${data.length} total records</p>`;
            
            container.innerHTML = html;
        }

        function updateAdminSelection() {
            const selectedRadio = document.querySelector('input[name="adminLevel"]:checked');
            selectedAdminLevel = selectedRadio ? selectedRadio.value : '';
            
            const proceedBtn = document.getElementById('proceedToMappingBtn');
            proceedBtn.disabled = !selectedAdminLevel;
            
            if (selectedAdminLevel) {
                setupAdminMappings();
                showAlert(`Selected administrative level: ${getAdminLevelDescription(selectedAdminLevel)}`, 'info');
            }
        }

        function getAdminLevelDescription(level) {
            const descriptions = {
                'national': 'National Level Only',
                'adm1': 'State/Province Level (ADM1)',
                'adm1_adm2': 'District Level (ADM1 + ADM2)',
                'adm1_adm2_adm3': 'Full Hierarchy (ADM1 + ADM2 + ADM3)'
            };
            return descriptions[level] || level;
        }

        function setupAdminMappings() {
            const container = document.getElementById('adminMappingSection');
            const columns = uploadedData.length > 0 ? Object.keys(uploadedData[0]) : [];
            
            let html = '';
            
            if (selectedAdminLevel !== 'national') {
                const adminLevels = selectedAdminLevel.split('_');
                
                adminLevels.forEach(level => {
                    const levelNum = level.replace('adm', '');
                    const levelName = level === 'adm1' ? 'State/Province' : 
                                    level === 'adm2' ? 'District' : 'Sub-district';
                    
                    html += `
                        <div class="form-group">
                            <label for="${level}Column">${levelName} (${level.toUpperCase()}):</label>
                            <select id="${level}Column" class="form-control">
                                <option value="">Select ${levelName.toLowerCase()} column...</option>
                    `;
                    
                    columns.forEach(col => {
                        html += `<option value="${col}">${col}</option>`;
                    });
                    
                    html += '</select></div>';
                });
            }
            
            container.innerHTML = html;
        }

        function setupColumnMappings(data) {
            if (data.length === 0) return;
            
            const columns = Object.keys(data[0]);
            const selectors = [
                'yearColumn', 'adm1Column', 'adm2Column', 'adm3Column',
                'confColumn', 'testColumn', 'presColumn', 
                'publicColumn', 'privateColumn', 'nonColumn'
            ];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">Select column...</option>';
                
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    select.appendChild(option);
                });
            });
        }

        function analyzeYears() {
            // Validate required mappings
            const requiredMappings = [
                'yearColumn', 'adm1Column', 'adm2Column', 'adm3Column',
                'confColumn', 'testColumn', 'presColumn'
            ];
            
            let isValid = true;
            requiredMappings.forEach(mapping => {
                const value = document.getElementById(mapping).value;
                if (!value) {
                    showAlert(`Please select a column for ${mapping.replace('Column', '')}`, 'error');
                    isValid = false;
                }
            });
            
            if (!isValid) return;
            
            // Store mappings
            const mappingIds = [
                'yearColumn', 'adm1Column', 'adm2Column', 'adm3Column',
                'confColumn', 'testColumn', 'presColumn', 
                'publicColumn', 'privateColumn', 'nonColumn'
            ];
            
            mappingIds.forEach(id => {
                const value = document.getElementById(id).value;
                if (value) {
                    columnMappings[id.replace('Column', '')] = value;
                }
            });
            
            // Analyze available years
            const yearColumn = columnMappings.year;
            availableYears = [...new Set(uploadedData.map(row => parseInt(row[yearColumn])))].filter(year => !isNaN(year)).sort();
            
            if (availableYears.length === 0) {
                showAlert('No valid years found in the year column', 'error');
                return;
            }
            
            displayAvailableYears();
            showStep(3);
        }

        function displayAvailableYears() {
            const infoContainer = document.getElementById('availableYearsInfo');
            infoContainer.innerHTML = `Found years in your data: <strong>${availableYears.join(', ')}</strong>`;
            
            const yearContainer = document.getElementById('yearSelection');
            yearContainer.innerHTML = '';
            
            availableYears.forEach(year => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="year_${year}" value="${year}" onchange="updateYearSelection()">
                    <label for="year_${year}">${year}</label>
                `;
                yearContainer.appendChild(checkboxItem);
            });
        }

        function updateYearSelection() {
            const checkboxes = document.querySelectorAll('#yearSelection input[type="checkbox"]:checked');
            selectedYears = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort();
            
            const startBtn = document.getElementById('startCalculationBtn');
            startBtn.disabled = selectedYears.length < 2;
            
            if (selectedYears.length >= 2) {
                setupYearSpecificMappings();
                document.getElementById('additionalColumnsSection').classList.remove('hidden');
                showAlert(`Selected ${selectedYears.length} years: ${selectedYears.join(', ')}`, 'info');
            } else {
                document.getElementById('additionalColumnsSection').classList.add('hidden');
                if (selectedYears.length > 0) {
                    showAlert('Please select at least 2 years for analysis', 'warning');
                }
            }
        }

        function setupYearSpecificMappings() {
            const container = document.getElementById('yearSpecificMappings');
            const columns = Object.keys(uploadedData[0]);
            
            let html = '<div class="mapping-grid">';
            
            selectedYears.forEach(year => {
                html += `
                    <div class="form-group">
                        <label for="pop_${year}">Population ${year}:</label>
                        <select id="pop_${year}" class="form-control">
                            <option value="">Select population column for ${year}...</option>
                `;
                
                columns.forEach(col => {
                    html += `<option value="${col}">${col}</option>`;
                });
                
                html += `
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rr_${year}">Reporting Rate ${year}:</label>
                        <select id="rr_${year}" class="form-control">
                            <option value="">Select reporting rate for ${year}...</option>
                `;
                
                columns.forEach(col => {
                    html += `<option value="${col}">${col}</option>`;
                });
                
                html += `</select></div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function startCalculations() {
            // Validate year-specific mappings
            let isValid = true;
            selectedYears.forEach(year => {
                const popCol = document.getElementById(`pop_${year}`).value;
                const rrCol = document.getElementById(`rr_${year}`).value;
                
                if (!popCol || !rrCol) {
                    showAlert(`Please select population and reporting rate columns for ${year}`, 'error');
                    isValid = false;
                }
            });
            
            if (!isValid) return;
            
            // Store year-specific mappings
            selectedYears.forEach(year => {
                columnMappings[`pop_${year}`] = document.getElementById(`pop_${year}`).value;
                columnMappings[`rr_${year}`] = document.getElementById(`rr_${year}`).value;
            });
            
            showStep(4);
            showAlert('Starting incidence calculations...', 'info');
            
            try {
                updateProgress(10);
                logProgress('Filtering and aggregating data by years...');
                
                // Process data
                processedData = await processData();
                
                updateProgress(60);
                logProgress('Calculating incidence indicators...');
                
                // Calculate indicators for each year
                selectedYears.forEach(year => {
                    calculateIndicators(processedData, year);
                });
                
                updateProgress(100);
                logProgress('Calculations completed successfully!');
                
                setTimeout(() => {
                    showStep(5);
                    displayResults();
                    showAlert('Incidence calculations completed!', 'success');
                }, 1000);
                
            } catch (error) {
                showAlert('Error during calculations: ' + error.message, 'error');
                logProgress(`Error: ${error.message}`);
            }
        }

        async function processData() {
            // Filter data for selected years
            const filteredData = uploadedData.filter(row => 
                selectedYears.includes(parseInt(row[columnMappings.year]))
            );
            
            updateProgress(20);
            
            // Group by admin levels and year, then aggregate
            const aggregatedData = {};
            selectedYears.forEach(year => {
                aggregatedData[year] = aggregateByAdmin(
                    filteredData.filter(row => parseInt(row[columnMappings.year]) === year),
                    year
                );
            });
            
            updateProgress(40);
            
            // Merge all years
            return mergeYearData(aggregatedData);
        }

        function aggregateByAdmin(data, year) {
            const grouped = {};
            
            data.forEach(row => {
                const key = `${row[columnMappings.adm1]}_${row[columnMappings.adm2]}_${row[columnMappings.adm3]}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        adm1: row[columnMappings.adm1],
                        adm2: row[columnMappings.adm2],
                        adm3: row[columnMappings.adm3],
                        [`conf_${year}`]: 0,
                        [`test_${year}`]: 0,
                        [`pres_${year}`]: 0
                    };
                }
                grouped[key][`conf_${year}`] += parseFloat(row[columnMappings.conf]) || 0;
                grouped[key][`test_${year}`] += parseFloat(row[columnMappings.test]) || 0;
                grouped[key][`pres_${year}`] += parseFloat(row[columnMappings.pres]) || 0;
            });
            
            return Object.values(grouped);
        }

        function mergeYearData(aggregatedData) {
            const merged = {};
            
            // Get all unique admin combinations
            selectedYears.forEach(year => {
                aggregatedData[year].forEach(row => {
                    const key = `${row.adm1}_${row.adm2}_${row.adm3}`;
                    if (!merged[key]) {
                        merged[key] = {
                            adm1: row.adm1,
                            adm2: row.adm2,
                            adm3: row.adm3
                        };
                    }
                    merged[key][`conf_${year}`] = row[`conf_${year}`];
                    merged[key][`test_${year}`] = row[`test_${year}`];
                    merged[key][`pres_${year}`] = row[`pres_${year}`];
                });
            });

            // Add additional data from original dataset
            const result = Object.values(merged);
            result.forEach(row => {
                const originalRow = uploadedData.find(d => 
                    d[columnMappings.adm1] === row.adm1 && 
                    d[columnMappings.adm2] === row.adm2 && 
                    d[columnMappings.adm3] === row.adm3
                );
                if (originalRow) {
                    selectedYears.forEach(year => {
                        row[`pop_${year}`] = originalRow[columnMappings[`pop_${year}`]];
                        row[`rr_${year}`] = originalRow[columnMappings[`rr_${year}`]];
                    });
                    row.public = originalRow[columnMappings.public] || 1;
                    row.private = originalRow[columnMappings.private] || 0;
                    row.non = originalRow[columnMappings.non] || 0;
                }
            });

            return result;
        }

        function calculateIndicators(data, year) {
            data.forEach(row => {
                const conf = row[`conf_${year}`] || 0;
                const test = row[`test_${year}`] || 0;
                const pres = row[`pres_${year}`] || 0;
                const pop = row[`pop_${year}`] || 1;
                const confRR = row[`rr_${year}`] || 1;
                const publicProp = row.public || 1;
                const privateProp = row.private || 0;
                const nonProp = row.non || 0;

                // Test Positivity Rate
                row[`TPR_${year}`] = test > 0 ? (conf / test) * 100 : 0;

                // Crude incidence per 1000
                row[`crude_incidence_${year}`] = (conf / pop) * 1000;

                // Presumed adjusted case count
                row[`presumed_adjusted_case_${year}`] = conf + (pres * (row[`TPR_${year}`] / 100));

                // Adjusted incidence 1
                row[`adjusted1_${year}`] = (row[`presumed_adjusted_case_${year}`] / pop) * 1000;

                // Presumed adjusted case divided by reporting rate
                row[`presumed_adjusted_case_RR_${year}`] = row[`presumed_adjusted_case_${year}`] / confRR;

                // Adjusted incidence 2
                row[`adjusted2_${year}`] = (row[`presumed_adjusted_case_RR_${year}`] / pop) * 1000;

                // Final adjustments for private and non-facility care
                const privateAdj = (row[`adjusted2_${year}`] * privateProp) / publicProp;
                const nonAdj = (row[`adjusted2_${year}`] * nonProp) / publicProp;
                const totalAdj = row[`adjusted2_${year}`] + privateAdj + nonAdj;
                row[`adjusted3_${year}`] = (totalAdj / pop) * 1000;
            });
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
        }

        function logProgress(message) {
            const container = document.getElementById('processingLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'alert alert-info';
            logEntry.style.margin = '0.5rem 0';
            logEntry.textContent = message;
            container.appendChild(logEntry);
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');
            
            if (!processedData || processedData.length === 0) {
                container.innerHTML = '<div class="alert alert-error">No results to display</div>';
                return;
            }

            let html = `<div class="alert alert-success">Calculations completed for ${selectedYears.length} years and ${processedData.length} administrative units</div>`;
            
            // Summary statistics
            html += '<h4 style="color: #93c5fd; margin: 1rem 0;">Summary Statistics</h4>';
            html += '<div class="table-container"><table class="table">';
            html += '<thead><tr><th>Year</th><th>Avg Crude Incidence</th><th>Avg Adjusted 1</th><th>Avg Adjusted 2</th><th>Avg Final Adjusted</th></tr></thead><tbody>';
            
            selectedYears.forEach(year => {
                const avgCrude = calculateAverage(processedData, `crude_incidence_${year}`);
                const avgAdj1 = calculateAverage(processedData, `adjusted1_${year}`);
                const avgAdj2 = calculateAverage(processedData, `adjusted2_${year}`);
                const avgAdj3 = calculateAverage(processedData, `adjusted3_${year}`);
                
                html += `<tr>
                    <td>${year}</td>
                    <td>${avgCrude.toFixed(2)}</td>
                    <td>${avgAdj1.toFixed(2)}</td>
                    <td>${avgAdj2.toFixed(2)}</td>
                    <td>${avgAdj3.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Sample data preview
            html += '<h4 style="color: #93c5fd; margin: 1rem 0;">Sample Results (First 5 Records)</h4>';
            html += '<div class="table-container"><table class="table">';
            html += '<thead><tr>';
            
            // Dynamic headers based on available admin levels
            if (columnMappings.adm1) html += '<th>ADM1</th>';
            if (columnMappings.adm2) html += '<th>ADM2</th>';
            if (columnMappings.adm3) html += '<th>ADM3</th>';
            
            selectedYears.forEach(year => {
                html += `<th>Crude ${year}</th><th>Final Adj ${year}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            processedData.slice(0, 5).forEach(row => {
                html += '<tr>';
                
                // Dynamic data based on available admin levels
                if (columnMappings.adm1) html += `<td>${row.adm1 || 'N/A'}</td>`;
                if (columnMappings.adm2) html += `<td>${row.adm2 || 'N/A'}</td>`;
                if (columnMappings.adm3) html += `<td>${row.adm3 || 'N/A'}</td>`;
                
                selectedYears.forEach(year => {
                    html += `<td>${(row[`crude_incidence_${year}`] || 0).toFixed(2)}</td>`;
                    html += `<td>${(row[`adjusted3_${year}`] || 0).toFixed(2)}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += `<p style="color: #9ca3af; margin-top: 1rem;">Showing 5 of ${processedData.length} records. Download for complete results.</p>`;
            
            container.innerHTML = html;
        }

        function calculateAverage(data, column) {
            const values = data.map(row => row[column] || 0).filter(val => !isNaN(val) && val > 0);
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
        }

        function downloadResults() {
            if (!processedData) {
                showAlert('No results to download', 'error');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Malaria Incidence Results');
            
            const filename = `malaria_incidence_${selectedYears.join('_')}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showAlert('Results downloaded successfully!', 'success');
        }

        function startOver() {
            uploadedData = null;
            processedData = null;
            columnMappings = {};
            selectedYears = [];
            availableYears = [];
            
            // Reset file input
            document.getElementById('dataFileInput').value = '';
            
            // Clear containers
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('additionalColumnsSection').classList.add('hidden');
            document.getElementById('processingLog').innerHTML = '';
            updateProgress(0);
            
            showStep(1);
            showAlert('Application reset. Please upload your data file again.', 'info');
        }

        // Make functions available globally
        window.updateAdminSelection = updateAdminSelection;
        window.updateYearSelection = updateYearSelection;
    </script>
</body>
</html>
